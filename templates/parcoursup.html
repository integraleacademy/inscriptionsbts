{% extends "base.html" %}
{% block body_class %}parcoursup-page{% endblock %}
{% block content %}

<div class="admin-wrapper">
  <header class="admin-header">
    <h2>ğŸ“ Gestion Parcoursup</h2>
    <p>Importez les candidatures Parcoursup et gÃ©rez leur suivi ici.</p>
    <form action="{{ url_for('parcoursup.check_sms_status_all') }}" method="post" style="margin-top:10px;margin-bottom:10px;">
  <button type="submit" class="btn primary">ğŸ” VÃ©rifier les statuts SMS</button>
</form>

  <form action="{{ url_for('parcoursup.relancer_non_ouverts') }}" method="post" style="margin-bottom:10px;">
  <button type="submit" class="btn danger">ğŸ“© Relancer les non ouverts</button>
</form>
  

  </header>

  <hr>

<!-- ğŸ§¾ Statistiques globales -->
<div class="stats-container">
  <div class="stat-card total">
    <h3>{{ stats.total }}</h3>
    <p>Total de candidatures</p>
  </div>

  <div class="stat-card mail">
    <h3>{{ stats.mail_sent }}</h3>
    <p>Mails envoyÃ©s ğŸ“§</p>
  </div>

  <div class="stat-card mail">
    <h3>{{ stats.mail_delivered }}</h3>
    <p>Mails dÃ©livrÃ©s ğŸŸ¢</p>
  </div>

  <div class="stat-card mail">
    <h3>{{ stats.mail_opened }}</h3>
    <p>Mails ouverts ğŸ‘ï¸</p>
  </div>

  <div class="stat-card mail">
    <h3>{{ stats.mail_clicked }}</h3>
    <p>Mails cliquÃ©s ğŸ”—</p>
  </div>

  <div class="stat-card sms">
    <h3>{{ stats.sms_sent }}</h3>
    <p>SMS envoyÃ©s ğŸ“±</p>
  </div>

  <div class="stat-card sms">
    <h3>{{ stats.sms_delivered }}</h3>
    <p>SMS dÃ©livrÃ©s ğŸŸ¢</p>
  </div>
</div>



  <form method="post" enctype="multipart/form-data" style="margin-bottom:20px;">
    <label for="file" style="font-weight:600;">ğŸ“¤ Importer ou vÃ©rifier un fichier Excel (.xlsx)</label><br>
    <input type="file" name="file" accept=".xlsx" required>

    <button formaction="{{ url_for('parcoursup.check_file') }}" class="btn secondary">
      ğŸ•µï¸â€â™‚ï¸ VÃ©rifier le fichier
    </button>

    <button formaction="{{ url_for('parcoursup.import_file') }}" class="btn primary" style="margin-left:10px;">
      ğŸ“¥ Importer les candidatures
    </button>
  </form>

  <hr>

  <!-- ğŸ¯ FILTRES AVANCÃ‰S -->
<div class="filters-card" style="
  background:#f8fff8;
  border:1px solid #cfe5cf;
  border-radius:10px;
  padding:15px 20px;
  margin:25px 0;
  box-shadow:0 1px 3px rgba(0,0,0,0.1);
">
<form method="get" action="{{ url_for('parcoursup.dashboard') }}" style="display:flex;flex-wrap:wrap;gap:15px;align-items:flex-end;">

<!-- ğŸ” Recherche instantanÃ©e -->
<div style="flex:1.5;min-width:220px;">
  <label for="searchInput" style="font-weight:600;display:block;margin-bottom:4px;">ğŸ” Recherche instantanÃ©e</label>
  <div style="display:flex;align-items:center;gap:6px;">
    <input
      type="text"
      id="searchInput"
      placeholder="Nom, prÃ©nom ou e-mail..."
      value="{{ request.args.get('search', '') }}"
      style="width:100%;padding:6px 10px;border-radius:6px;border:1px solid #ccc;"
    >
    <button type="button" class="btn secondary" disabled style="opacity:0.6;cursor:default;">ğŸ”</button>
  </div>
  <small style="color:#666;">(Recherche automatique en temps rÃ©el)</small>
</div>


  <!-- ğŸ“Œ Statut -->
  <div style="flex:1;min-width:180px;">
    <label for="statut" style="font-weight:600;display:block;margin-bottom:4px;">ğŸ“Œ Statut</label>
    <select id="statut" name="statut" style="width:100%;padding:6px 10px;border-radius:6px;border:1px solid #ccc;">
      <option value="">Tous</option>
      {% for key, style in STATUTS_STYLE.items() %}
        <option value="{{ key }}" {% if request.args.get('statut') == key %}selected{% endif %}>
          {{ style.label }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- ğŸ“ Formation -->
  <div style="flex:1;min-width:180px;">
    <label for="formation" style="font-weight:600;display:block;margin-bottom:4px;">ğŸ“ Formation</label>
    <select id="formation" name="formation" style="width:100%;padding:6px 10px;border-radius:6px;border:1px solid #ccc;">
      <option value="">Toutes</option>
      {% for f in formations %}
        <option value="{{ f }}" {% if request.args.get('formation') == f %}selected{% endif %}>
          {{ f }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- ğŸ’» Mode -->
  <div style="flex:1;min-width:180px;">
    <label for="mode" style="font-weight:600;display:block;margin-bottom:4px;">ğŸ’» Mode</label>
    <select id="mode" name="mode" style="width:100%;padding:6px 10px;border-radius:6px;border:1px solid #ccc;">
      <option value="">Tous</option>
      {% for m in modes %}
        <option value="{{ m }}" {% if request.args.get('mode') == m %}selected{% endif %}>
          {{ m }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div style="display:flex;gap:10px;">
    <button type="submit" class="btn primary">ğŸ” Filtrer</button>
    <a href="{{ url_for('parcoursup.dashboard') }}" class="btn secondary">â™»ï¸ RÃ©initialiser</a>
  </div>
</form>

</div>


  <h3>ğŸ“‹ Liste des candidats Parcoursup</h3>
  {% if rows %}
  <table class="admin-table">
    <thead>
      <tr>
        <th>Nom</th>
        <th>PrÃ©nom</th>
        <th>TÃ©lÃ©phone</th>
        <th>Email</th>
        <th>Formation</th>
        <th>Mode</th>
        <th>Mail OK</th>
        <th>SMS OK</th>
        <th>Statut</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr {% if r.alerte %}style="background:#ffe6e6;" title="Aucun clic / ouverture aprÃ¨s 48h"{% endif %}>

        <td>{{ r.nom }}</td>
        <td>{{ r.prenom }}</td>
        <td>{{ r.telephone }}</td>
        <td>{{ r.email }}</td>
        <td>{{ r.formation }}</td>
        <td>{{ r.mode }}</td>
       <td style="text-align:center;">
  {% if r.mail_status_label %}
    <div style="display:flex;align-items:center;justify-content:center;gap:6px;">
      {% if r.mail_status_label == 'CliquÃ©' %}
        ğŸ”—
      {% elif r.mail_status_label == 'Ouvert' %}
        ğŸ‘ï¸
      {% elif r.mail_status_label == 'DÃ©livrÃ©' %}
        âœ…
      {% elif r.mail_status_label == 'EnvoyÃ©' %}
        ğŸ“¤
      {% else %}
        âšª
      {% endif %}
      <span style="color:{{ r.mail_status_color }};font-weight:600;">
        {{ r.mail_status_label }}
      </span>
    </div>
  {% else %}
    <span style="color:#999;">â³ En attente</span>
  {% endif %}
</td>



<td>
  {% if r.sms_ok %}
    {% if r.sms_status == "delivered" %}
      <span class="status-icon ok" title="SMS livrÃ© ğŸŸ¢">âœ…</span> <small style="color:#2ecc71;">ğŸŸ¢ LivrÃ©</small>
    {% elif r.sms_status == "failed" %}
      <span class="status-icon fail" title="Ã‰chec de livraison ğŸ”´">âŒ</span> <small style="color:#e74c3c;">ğŸ”´ Ã‰chouÃ©</small>
    {% elif r.sms_status == "unknown" %}
      <span class="status-icon" title="Statut inconnu âšª">âšª</span> <small style="color:#999;">Inconnu</small>
    {% else %}
      <span class="status-icon" title="En attente ğŸŸ¡">â³</span> <small style="color:#f4c45a;">ğŸŸ¡ En attente</small>
    {% endif %}
  {% else %}
    <span class="status-icon fail" title="SMS non envoyÃ© âŒ">âŒ</span>
  {% endif %}
</td>





        {% set style = STATUTS_STYLE.get(r.statut) %}
        <td style="
          text-align:center;
          font-weight:600;
          color:white;
          background:{{ style.color if style else '#999' }};
          border-radius:6px;
          padding:4px 8px;
        ">
          {{ style.label if style else r.statut }}
        </td>

<td style="text-align:center;">
  <form action="{{ url_for('parcoursup.relancer_individuel', cid=r.id) }}" method="post" style="display:inline;">
    <button type="submit" class="btn small" style="background:#f4c45a;color:black;" title="Renvoyer mail + SMS">
      ğŸ”
    </button>
  </form>

  <form action="{{ url_for('parcoursup.delete_candidat', cid=r.id) }}" method="post" style="display:inline;">
    <button type="submit" class="btn small danger" onclick="return confirm('Supprimer cette candidature ?')">ğŸ—‘ï¸</button>
  </form>

  <button class="btn small btn-logs" data-id="{{ r.id }}" style="background:#555;color:white;">
    ğŸ•“ Logs
  </button>
</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>Aucune candidature importÃ©e pour le moment.</p>
  {% endif %}
</div>

<!-- ğŸ•“ MODALE LOGS â€“ Historique dÃ©taillÃ© -->
<div id="logsModal" class="modal hidden">
  <div class="modal-content" style="width:600px;max-height:80vh;overflow-y:auto;">
    <h3>ğŸ•“ Historique des envois et relances</h3>
    <ul id="logsList" class="timeline"></ul>
    <div style="text-align:center;margin-top:15px;">
      <button class="btn primary" onclick="closeLogsModal()">Fermer</button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("logsModal");
  const list = document.getElementById("logsList");

  // === Ouvrir la modale et charger les logs ===
  document.querySelectorAll(".btn-logs").forEach(btn => {
    btn.addEventListener("click", async () => {
      const cid = btn.dataset.id;
      list.innerHTML = "<li>Chargement...</li>";
      modal.classList.remove("hidden");

      try {
        const resp = await fetch(`/parcoursup/logs/${cid}`);
        const logs = await resp.json();
        list.innerHTML = "";

        if (logs.length === 0) {
          list.innerHTML = "<li>Aucun log pour ce candidat.</li>";
          return;
        }

        logs.reverse().forEach(l => {
          const li = document.createElement("li");
          li.style.padding = "6px 8px";
          li.style.borderBottom = "1px solid #eee";
          li.style.display = "flex";
          li.style.alignItems = "center";
          li.style.gap = "8px";

          // === Gestion des icÃ´nes et couleurs ===
          let icon = "ğŸ“„";
          let color = "#333";
          let text = "";

          switch (l.type) {
            case "mail":
              icon = "ğŸ“¤";
              color = "#007bff";
              text = `Mail envoyÃ© Ã  ${l.dest || ""}`;
              break;
            case "mail_status":
              if (l.event === "opened" || l.event === "unique_opened") {
                icon = "ğŸ‘ï¸"; color = "#3498db"; text = "Mail ouvert";
              } else if (l.event === "click") {
                icon = "ğŸ”—"; color = "#8e44ad"; text = "Lien cliquÃ©";
              } else if (l.event === "delivered") {
                icon = "âœ…"; color = "#2ecc71"; text = "Mail dÃ©livrÃ©";
              } else {
                text = `Mail statut : ${l.event}`;
              }
              break;
            case "sms":
              icon = "ğŸ“±";
              color = "#27ae60";
              text = `SMS envoyÃ© Ã  ${l.dest || ""}`;
              break;
            case "sms_status":
              if (l.event === "delivered") {
                icon = "ğŸ“©"; color = "#2ecc71"; text = "SMS livrÃ©";
              } else if (l.event === "failed") {
                icon = "âŒ"; color = "#e74c3c"; text = "SMS Ã©chouÃ©";
              } else {
                text = `SMS statut : ${l.event}`;
              }
              break;
            case "relance_auto":
              icon = "ğŸ”";
              color = "#f39c12";
              text = "Relance automatique (48h)";
              break;
            case "relance_manuelle":
              icon = "ğŸ§‘â€ğŸ’»";
              color = "#f4c45a";
              text = "Relance manuelle (admin)";
              break;
            default:
              text = l.type;
          }

          const date = l.date ? new Date(l.date).toLocaleString("fr-FR") : "";
          li.innerHTML = `<span style="font-size:18px;">${icon}</span>
                          <span style="color:${color};font-weight:600;">${text}</span>
                          <span style="margin-left:auto;color:#888;font-size:12px;">${date}</span>`;
          list.appendChild(li);
        });

      } catch (err) {
        list.innerHTML = `<li>Erreur de chargement des logs.</li>`;
      }
    });
  });
});

// === Fermer la modale ===
function closeLogsModal() {
  document.getElementById("logsModal").classList.add("hidden");
}
</script>


{% endblock %}




















