{% extends "base.html" %}
{% block body_class %}parcoursup-page{% endblock %}
{% block content %}

<div class="admin-wrapper">
  <header class="admin-header">
    <h2>🎓 Gestion Parcoursup</h2>
    <p>Importez les candidatures Parcoursup et gérez leur suivi ici.</p>
    <form action="{{ url_for('parcoursup.check_sms_status_all') }}" method="post" style="margin-top:10px;margin-bottom:10px;">
  <button type="submit" class="btn primary">🔁 Vérifier les statuts SMS</button>
</form>

  </header>

  <hr>

  <!-- 🧾 Statistiques globales -->
<div class="stats-container">
  <div class="stat-card total">
    <h3>{{ stats.total }}</h3>
    <p>Total de candidatures</p>
  </div>
  <div class="stat-card ok">
    <h3>{{ stats.both_ok }}</h3>
    <p>Mails + SMS envoyés ✅</p>
  </div>
  <div class="stat-card mail">
    <h3>{{ stats.mail_ok }}</h3>
    <p>Mails envoyés 📧</p>
  </div>
  <div class="stat-card sms">
    <h3>{{ stats.sms_ok }}</h3>
    <p>SMS envoyés 📱</p>
  </div>
  <div class="stat-card incomplete">
    <h3>{{ stats.incomplete }}</h3>
    <p>Incomplets ⚠️</p>
  </div>
</div>


  <form method="post" enctype="multipart/form-data" style="margin-bottom:20px;">
    <label for="file" style="font-weight:600;">📤 Importer ou vérifier un fichier Excel (.xlsx)</label><br>
    <input type="file" name="file" accept=".xlsx" required>

    <button formaction="{{ url_for('parcoursup.check_file') }}" class="btn secondary">
      🕵️‍♂️ Vérifier le fichier
    </button>

    <button formaction="{{ url_for('parcoursup.import_file') }}" class="btn primary" style="margin-left:10px;">
      📥 Importer les candidatures
    </button>
  </form>

  <hr>

  <form method="get" action="{{ url_for('parcoursup.dashboard') }}" 
        style="margin-bottom:20px;display:flex;gap:10px;align-items:center;">
    <label for="statut" style="font-weight:600;">🎯 Filtrer par statut :</label>
    <select id="statut" name="statut" style="padding:5px 10px;border-radius:6px;">
      <option value="">Tous les statuts</option>
      {% for key, style in STATUTS_STYLE.items() %}
        <option value="{{ key }}" {% if request.args.get('statut') == key %}selected{% endif %}>
          {{ style.label }}
        </option>
      {% endfor %}
    </select>
    <button type="submit" class="btn primary">Filtrer</button>
    <a href="{{ url_for('parcoursup.dashboard') }}" class="btn secondary">↻ Réinitialiser</a>
  </form>

  <h3>📋 Liste des candidats Parcoursup</h3>
  {% if rows %}
  <table class="admin-table">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Prénom</th>
        <th>Téléphone</th>
        <th>Email</th>
        <th>Formation</th>
        <th>Mode</th>
        <th>Mail OK</th>
        <th>SMS OK</th>
        <th>Statut</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td>{{ r.nom }}</td>
        <td>{{ r.prenom }}</td>
        <td>{{ r.telephone }}</td>
        <td>{{ r.email }}</td>
        <td>{{ r.formation }}</td>
        <td>{{ r.mode }}</td>
        <td>
  {% set last_mail_status = "" %}
  {% if r.logs %}
    {% for log in r.logs | fromjson | reverse %}
      {% if log.type == "mail_status" %}
        {% set last_mail_status = log.event %}
        {% break %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if last_mail_status == "delivered" %}
    <span class="status-icon ok" title="Mail livré 🟢">✅</span> 
    <small style="color:#2ecc71;">🟢 Livré</small>
  {% elif last_mail_status in ["opened", "unique_opened"] %}
    <span class="status-icon ok" title="Mail ouvert 👁️">👁️</span> 
    <small style="color:#3498db;">👁️ Ouvert</small>
  {% elif last_mail_status == "click" %}
    <span class="status-icon ok" title="Lien cliqué 🔗">🔗</span> 
    <small style="color:#f4c45a;">🔗 Cliqué</small>
  {% elif last_mail_status in ["bounced", "hard_bounce", "soft_bounce"] %}
    <span class="status-icon fail" title="Mail non délivré ❌">❌</span> 
    <small style="color:#e74c3c;">❌ Échec</small>
  {% elif r.mail_ok %}
    <span class="status-icon ok" title="Mail envoyé ✅">✅</span> 
    <small style="color:#999;">✅ Envoyé</small>
  {% else %}
    <span class="status-icon fail" title="Mail non envoyé ❌">❌</span> 
    <small style="color:#999;">⏳ En attente</small>
  {% endif %}
</td>


<td>
  {% if r.sms_ok %}
    {% if r.sms_status == "delivered" %}
      <span class="status-icon ok" title="SMS livré 🟢">✅</span> <small style="color:#2ecc71;">🟢 Livré</small>
    {% elif r.sms_status == "failed" %}
      <span class="status-icon fail" title="Échec de livraison 🔴">❌</span> <small style="color:#e74c3c;">🔴 Échoué</small>
    {% elif r.sms_status == "unknown" %}
      <span class="status-icon" title="Statut inconnu ⚪">⚪</span> <small style="color:#999;">Inconnu</small>
    {% else %}
      <span class="status-icon" title="En attente 🟡">⏳</span> <small style="color:#f4c45a;">🟡 En attente</small>
    {% endif %}
  {% else %}
    <span class="status-icon fail" title="SMS non envoyé ❌">❌</span>
  {% endif %}
</td>





        {% set style = STATUTS_STYLE.get(r.statut) %}
        <td style="
          text-align:center;
          font-weight:600;
          color:white;
          background:{{ style.color if style else '#999' }};
          border-radius:6px;
          padding:4px 8px;
        ">
          {{ style.label if style else r.statut }}
        </td>

        <td style="text-align:center;">
          <form action="{{ url_for('parcoursup.delete_candidat', cid=r.id) }}" method="post" style="display:inline;">
            <button type="submit" class="btn small danger" onclick="return confirm('Supprimer cette candidature ?')">🗑️</button>
          </form>
          <button class="btn small" style="background:#555;color:white;"
                  onclick="openLogsModal('{{ r.id }}')">🕓 Logs</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>Aucune candidature importée pour le moment.</p>
  {% endif %}
</div>

<!-- 🕓 MODALE LOGS -->
<div id="logsModal" class="modal hidden">
  <div class="modal-content" style="width:600px;max-height:80vh;overflow-y:auto;">
    <h3>🕓 Historique des actions</h3>
    <ul id="logsList" style="list-style:none;padding:0;font-size:14px;"></ul>
    <div style="text-align:center;margin-top:15px;">
      <button class="btn" onclick="closeLogsModal()">Fermer</button>
    </div>
  </div>
</div>

<script>
function openLogsModal(cid) {
  fetch(`/parcoursup/logs/${cid}`)
    .then(r => r.json())
    .then(logs => {
      const list = document.getElementById("logsList");

      if (!Array.isArray(logs) || logs.length === 0) {
        list.innerHTML = "<li>Aucune action enregistrée</li>";
      } else {
        list.innerHTML = logs.map(l => {
          const date = l.date ? l.date.slice(0, 19).replace("T", " ") : "inconnue";
          const type = l.type || "inconnu";
          let details = "";

          if (l.event) {
            // ex: delivered / failed / pending
            const color =
              l.event === "delivered" ? "#2ecc71" :
              l.event === "failed" ? "#e74c3c" :
              l.event === "pending" ? "#f4c45a" : "#999";
            details = `<span style="color:${color};font-weight:600;">${l.event}</span>`;
          } else if (l.dest) {
            details = `<span style="color:#555;">${l.dest}</span>`;
          }

          return `<li>📅 <b>${date}</b> — <span style="color:#3498db;">${type}</span> ${details}</li>`;
        }).join("");
      }

      document.getElementById("logsModal").classList.remove("hidden");
    })
    .catch(err => alert("Erreur de chargement des logs : " + err));
}

function closeLogsModal() {
  document.getElementById("logsModal").classList.add("hidden");
}
</script>


{% endblock %}








