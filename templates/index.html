{% extends "base.html" %}
{% block content %}

<div class="form-container">
  <h2>📝 Pré-inscriptions BTS 2026</h2>


  <div class="notice">
    <p>Vous allez compléter votre dossier de pré-inscription pour intégrer l’un de nos BTS à partir de septembre 2026.</p>
    <ol>
      <li>Complétez ce formulaire. Vous recevrez ensuite un <strong>accusé de réception</strong> avec votre numéro de dossier.</li>
      <li>Dans un délai de 15 jours, nous étudierons votre dossier et vous recevrez notre <em>avis d’admission</em>.</li>
      <li>En cas d’avis favorable, vous pourrez confirmer votre inscription en cliquant sur <strong>« Je confirme mon inscription »</strong>.</li>
    </ol>
    <p class="help">Besoin d’aide ? <a href="https://assistance-alw9.onrender.com/" target="_blank">Cliquez ici</a> ou appelez le <strong>04 22 47 07 68</strong>.</p>
  </div>

  <form id="inscriptionForm" class="tabs-form" method="post" action="{{ url_for('submit') }}" enctype="multipart/form-data">
    <div class="tabs">
      <button type="button" data-tab="tab1" class="active">🪪 Infos générales</button>
      <button type="button" data-tab="tab2">🎓 Formation</button>
      <button type="button" data-tab="tab3">🧩 Infos complémentaires</button>
      <button type="button" data-tab="tab4">💬 Projet motivé</button>
      <button type="button" data-tab="tab5">📎 Pièces justificatives</button>
    </div>

      <!-- 🔢 Barre de progression -->
<div class="progress-container">
  <div class="progress-bar" id="progressBar"></div>
</div>

  <div class="progress-info" id="progressInfo">Étape 1 sur 5</div>

    <!-- 🪪 Étape 1 -->
    <div id="tab1" class="tab active">
      <div class="grid">
        <label>Nom <input name="nom" required></label>
        <label>Prénom <input name="prenom" required></label>
        <label>Sexe
          <select name="sexe" required>
            <option value="">—</option>
            <option>Homme</option>
            <option>Femme</option>
          </select>
        </label>
        <label>Date de naissance <input type="date" name="date_naissance" required></label>
        <!-- Bloc Responsable Légal (caché par défaut) -->
<div id="bloc-resp-legal" style="display:none; margin-top:20px; background:#fff8e1; padding:15px; border-left:4px solid #f4c45a; border-radius:8px;">
  <h4>👨‍👩‍👧 Informations du responsable légal</h4>
  <p style="font-size:14px; color:#555;">⚠️ Vous êtes mineur(e) à la date d’inscription — merci d’indiquer les coordonnées du responsable légal :</p>
  
  <div class="grid">
    <label>Nom du responsable légal <input name="resp_nom"></label>
    <label>Prénom du responsable légal <input name="resp_prenom"></label>
    <label>Email du responsable légal <input type="email" name="resp_email"></label>
    <label>Téléphone du responsable légal <input name="resp_tel" pattern="\d{10}"></label>
  </div>
  <input type="hidden" name="est_mineur" id="est_mineur" value="0">
</div>

        <label>Ville de naissance <input name="ville_naissance" required></label>
        <label>Code postal de naissance <input name="cp_naissance" required></label>
        <label>Pays de naissance <input name="pays_naissance" required></label>
<label>Numéro de sécurité sociale
  <input 
    name="num_secu"
    id="num_secu"
    type="text"
    inputmode="text"
    maxlength="15"
    required
    placeholder="Ex : 2842A12345678946"
    oninput="this.value = this.value.toUpperCase().replace(/[^0-9AB]/g, '').slice(0,15); verifierNumSecu();"
  >
  <small id="numSecuHelp" style="color:#666;font-size:13px;">15 caractères attendus (chiffres ou A/B pour la Corse)</small>
</label>


        <label>Email <input type="email" name="email" required></label>
        <label>Confirmer l’email <input type="email" name="email_confirm" required></label>
        <label>Téléphone portable <input name="tel" pattern="\d{10}" required></label>
        <label>Adresse postale <input name="adresse" required></label>
        <label>Code postal <input name="cp" required></label>
        <label>Ville <input name="ville" required></label>
      </div>
      <div class="actions">
        <button type="button" class="btn primary next">Étape suivante ➡️</button>
      </div>
    </div>

    <!-- 🎓 Étape 2 -->
<div id="tab2" class="tab">
  <label>Formation souhaitée
    <select name="bts" required>
      <option value="">—</option>
      <option value="MOS">BTS MOS (Sécurité)</option>
      <option value="MCO">BTS MCO</option>
      <option value="PI">BTS PI</option>
      <option value="CI">BTS CI</option>
      <option value="NDRC">BTS NDRC</option>
      <option value="CG">BTS Comptabilité-Gestion</option>
    </select>
  </label>
  <label>Modalité
    <select name="mode" required>
      <option value="">—</option>
      <option value="presentiel">Présentiel (Puget-sur-Argens)</option>
      <option value="distanciel">100% à distance (visioconférence)</option>
    </select>
  </label>

 <!-- 🟢 Bloc spécifique BTS MOS Sécurité -->
<div id="mos-section" class="mos" style="display:none; margin-top:20px;">

  <h4>À cocher, une seule case possible :</h4>

  <label>
    <input type="radio" name="bac_status" value="bac_ms">
    Je suis titulaire d’un Bac Pro MS métiers de la sécurité
  </label><br>

  <label>
    <input type="radio" name="bac_status" value="bac_ms_en_cours">
    Je passe mon Bac Pro MS métiers de la sécurité en 2026
  </label><br>

  <label>
    <input type="radio" name="bac_status" value="carte_cnaps">
    Je suis déjà titulaire d’une carte professionnelle CNAPS
  </label><br>

  <label>
    <input type="radio" name="bac_status" value="autre">
    Aucun de ces cas (bac général, bac technologique, bac pro hors MS, autre)
  </label>

  <!-- Zone affichée si "autre" -->
  <div id="bloc-bac-autre" style="display:none; margin-top:10px;">
    <label>
      Préciser (si autre) :
      <input type="text" name="bac_autre" placeholder="Ex : Bac général STMG">
    </label>
  </div>

  <!-- Bloc explicatif + choix APS -->
  <div id="mos-explication" style="display:none; margin-top:15px; background:#fff8e1; padding:15px; border-left:4px solid #f4c45a; border-radius:8px;">
    <p>
      Pour accéder à notre <strong>BTS Management Opérationnel de la Sécurité (MOS)</strong>,
      vous devez être titulaire d’une <strong>carte professionnelle “agent de sécurité privée”</strong>
      délivrée par le Ministère de l’intérieur (CNAPS).
    </p>
    <p>
      Cette carte professionnelle vous sera demandée par votre future entreprise dans le cadre de l’alternance.
    </p>
    <p>
      ➡️ <a href="https://www.canva.com/design/DAFyt9PCLzk/crHFPARJiocR1wDYdodMJw/view?utm_content=DAFyt9PCLzk&utm_campaign=designshare&utm_medium=link&utm_source=editor"
      target="_blank" style="color:#007bff; font-weight:600;">Plus d’infos sur le CNAPS ici</a>
    </p>
    <p>
      Cette formation est proposée au tarif <strong>950 € (apprenti)</strong> au lieu de 1650 €.
      Le chèque sera à envoyer par courrier lorsque nous aurons confirmé votre inscription.
    </p>

    <p><strong>Souhaitez-vous suivre la formation APS ?</strong></p>
    <label>
      <input type="checkbox" name="aps_souhaitee" value="1">
      Oui, je souhaite suivre la formation agent de sécurité privée (APS)
    </label>

    <div id="bloc-aps-session" style="display:none; margin-top:10px;">
      <p><strong>Choisissez votre session :</strong></p>
      <label>
        <input type="radio" name="aps_session" value="puget">
        8 juillet → 12 août 2026 — Intégrale Academy (Puget-sur-Argens)
      </label><br>
      <label>
        <input type="radio" name="aps_session" value="autre">
        8 juillet → 12 août 2026 — Autre lieu
      </label>
    </div>
  </div>
</div>

<script>
// --- Afficher automatiquement la section MOS ---
const btsSelect = document.querySelector('select[name="bts"]');
const mosSection = document.getElementById('mos-section');
const mosExplication = document.getElementById('mos-explication');
const blocBacAutre = document.getElementById('bloc-bac-autre');
const blocApsSession = document.getElementById('bloc-aps-session');

if (btsSelect) {
  btsSelect.addEventListener('change', () => {
    if (btsSelect.value === 'MOS') {
      mosSection.style.display = 'block';
    } else {
      mosSection.style.display = 'none';
      mosExplication.style.display = 'none';
      blocBacAutre.style.display = 'none';
    }
  });
}

// --- Si "Aucun de ces cas" est coché ---
document.addEventListener('change', (e) => {
  if (e.target.name === 'bac_status') {
    if (e.target.value === 'autre') {
      mosExplication.style.display = 'block';
      blocBacAutre.style.display = 'block';
    } else {
      blocBacAutre.style.display = 'none';
      if (e.target.value === 'carte_cnaps') {
        mosExplication.style.display = 'none';
      }
    }
  }
  if (e.target.name === 'aps_souhaitee') {
    blocApsSession.style.display = e.target.checked ? 'block' : 'none';
  }
});
</script>

  <!-- Boutons d'étape -->
  <div class="actions">
    <button type="button" class="btn prev">⬅️ Étape précédente</button>
    <button type="button" class="btn primary next">Étape suivante ➡️</button>
  </div>
</div>




    <!-- 🧩 Étape 3 -->
    <div id="tab3" class="tab">
      <div class="grid">
        <label>Baccalauréat
          <select name="bac_status" required>
            <option value="">—</option>
            <option>Oui</option>
            <option>Non</option>
            <option>Prévu en 2026</option>
          </select>
        </label>
        <label>Type de bac
          <select name="bac_type">
            <option value="">—</option>
            <option>Général</option>
            <option>Technologique</option>
            <option>Professionnel</option>
            <option>Autre</option>
          </select>
        </label>
        <label>Si “Autre”, préciser <input name="bac_autre"></label>
        <label>Permis B
          <select name="permis_b">
            <option value="">—</option>
            <option>Oui</option>
            <option>Non</option>
          </select>
        </label>
      </div>

      <div class="actions">
        <button type="button" class="btn prev">⬅️ Étape précédente</button>
        <button type="button" class="btn primary next">Étape suivante ➡️</button>
      </div>
    </div>

    <!-- 💬 Étape 4 -->
    <div id="tab4" class="tab">
      <label>Pourquoi souhaitez-vous intégrer ce BTS ?
        <textarea name="projet_pourquoi" rows="4" required></textarea>
      </label>
      <label>Quel est votre projet professionnel ?
        <textarea name="projet_objectif" rows="4" required></textarea>
      </label>
      <label>Quelles sont vos passions ?
        <textarea name="projet_passions" rows="4" required></textarea>
      </label>

      <div class="actions">
        <button type="button" class="btn prev">⬅️ Étape précédente</button>
        <button type="button" class="btn primary next">Étape suivante ➡️</button>
      </div>
    </div>

    <!-- 📎 Étape 5 -->
    <div id="tab5" class="tab">
      <div class="grid">
        <label>Carte d’identité / Passeport (1 fichier obligatoire) <input type="file" name="ci" accept="application/pdf,image/*" required></label>
        <label>Deuxième page / verso (facultatif) <input type="file" name="ci2" accept="application/pdf,image/*"></label>
        <label>Photo d’identité <input type="file" name="photo" accept="image/*" required></label>
        <p class="photo-exemple">
          <img src="{{ url_for('static', filename='photo-exemple.png') }}" alt="Exemples de photos" style="max-width:280px;border-radius:8px;">
          <br><small>✅ Photo nette, fond neutre — ❌ Pas de selfie ni d’arrière-plan visible</small>
        </p>
        <label>Carte Vitale (PDF uniquement) <input type="file" name="carte_vitale" accept="application/pdf" required></label>
        <label>CV (PDF) <input type="file" name="cv" accept="application/pdf" required></label>
        <label>Lettre de motivation (PDF) <input type="file" name="lm" accept="application/pdf" required></label>
      </div>
      <div class="actions">
        <button type="button" class="btn prev">⬅️ Étape précédente</button>
        <button class="btn primary" type="submit">✅ Envoyer ma pré-inscription</button>
      </div>
    </div>

   

  </form>
</div>

<script>
// --- Vérification du NIR (avec 2A / 2B autorisés et conservés) ---
function verifierNumSecu() {
  const input = document.getElementById("num_secu");
  const help = document.getElementById("numSecuHelp");
  let val = input.value.trim().toUpperCase();
  let nir = val.replace(/\s+/g, "");

  // ✅ Autoriser chiffres et lettres A/B
  if (!/^[0-9AB]{13,15}$/.test(nir)) {
    help.textContent = "❌ Format invalide — seuls chiffres et A/B sont autorisés (15 caractères attendus)";
    help.style.color = "red";
    input.style.borderColor = "red";
    return false;
  }

  // 🔁 copie pour le calcul (convertit seulement temporairement 2A / 2B)
  const nirCalc = nir.replace("2A", "19").replace("2B", "18");
  const digits = nirCalc.replace(/\D/g, "");

  if (digits.length !== 15) {
    help.textContent = "❌ Numéro incomplet — 15 chiffres attendus (A/B acceptés pour la Corse)";
    help.style.color = "red";
    input.style.borderColor = "red";
    return false;
  }

  // ✅ Vérification de la clé de contrôle
  try {
    const corps = digits.slice(0, 13);
    const cle = parseInt(digits.slice(13, 15), 10);
    const calc = 97n - (BigInt(corps) % 97n);
    if (Number(calc) !== cle) {
      help.textContent = "❌ Clé de contrôle incorrecte";
      help.style.color = "red";
      input.style.borderColor = "red";
      return false;
    }
  } catch {
    help.textContent = "❌ Format invalide";
    help.style.color = "red";
    input.style.borderColor = "red";
    return false;
  }

  // ✅ Cohérence avec date de naissance et sexe
  const dateInput = document.querySelector('input[name="date_naissance"]');
  const sexeSelect = document.querySelector('select[name="sexe"]');
  const s = parseInt(digits[0], 10);
  const yy = digits.slice(1, 3);
  const mm = digits.slice(3, 5);

  if (dateInput && dateInput.value) {
    const d = new Date(dateInput.value);
    const yyExpected = String(d.getFullYear()).slice(-2);
    const mmExpected = String(d.getMonth() + 1).padStart(2, "0");

    if (yy !== yyExpected) {
      help.textContent = `❌ Année ${yy} incohérente (attendu ${yyExpected})`;
      help.style.color = "red";
      input.style.borderColor = "red";
      return false;
    }

    if (/^0[1-9]|1[0-2]$/.test(mm) && mm !== mmExpected) {
      help.textContent = `❌ Mois ${mm} incohérent (attendu ${mmExpected})`;
      help.style.color = "red";
      input.style.borderColor = "red";
      return false;
    }
  }

  if (sexeSelect && sexeSelect.value) {
    const valSexe = sexeSelect.value.toLowerCase();
    if ((valSexe === "homme" && s !== 1) || (valSexe === "femme" && s !== 2)) {
      help.textContent = "❌ Sexe incohérent avec le NIR";
      help.style.color = "red";
      input.style.borderColor = "red";
      return false;
    }
  }

  // ✅ Tout est bon
  help.textContent = "✅ Numéro valide et cohérent";
  help.style.color = "green";
  input.style.borderColor = "#28a745";
  return true;
}

// Vérification automatique à chaque saisie
["input", "change"].forEach(evt => {
  document.getElementById("num_secu")?.addEventListener(evt, verifierNumSecu);
  document.querySelector('input[name="date_naissance"]')?.addEventListener(evt, verifierNumSecu);
  document.querySelector('select[name="sexe"]')?.addEventListener(evt, verifierNumSecu);
});
</script>
<script>
// --- Navigation contrôlée entre les onglets ---
const tabs = document.querySelectorAll(".tabs button");
const formTabs = document.querySelectorAll(".tab");
let currentStep = 0;

// --- Fonction pour afficher un onglet ---
function showTab(index) {
  formTabs.forEach((tab, i) => tab.classList.toggle("active", i === index));
  tabs.forEach((btn, i) => btn.classList.toggle("active", i === index));

  // 🟡 Met à jour la barre de progression
  const progress = document.getElementById("progressBar");
  if (progress) {
    const percent = ((index + 1) / formTabs.length) * 100;
    progress.style.width = percent + "%";
      const info = document.getElementById("progressInfo");
  if (info) {
    info.textContent = `Étape ${index + 1} sur ${formTabs.length}`;
  }

  }
}


// --- Fonction pour valider une étape ---
function validateStep(stepIndex) {
  const currentTab = formTabs[stepIndex];
  const inputs = currentTab.querySelectorAll("input, select, textarea");
  let allValid = true;

  for (let input of inputs) {
    if (input.hasAttribute("required") && !input.value.trim()) {
      input.focus();
      input.reportValidity();
      allValid = false;
      break;
    }
  }

  return allValid;
}

// --- Étape suivante ---
document.querySelectorAll(".next").forEach(btn => {
  btn.addEventListener("click", () => {
    if (validateStep(currentStep)) {
      currentStep++;
      if (currentStep >= formTabs.length) currentStep = formTabs.length - 1;
      showTab(currentStep);
    }
  });
});

// --- Étape précédente ---
document.querySelectorAll(".prev").forEach(btn => {
  btn.addEventListener("click", () => {
    currentStep--;
    if (currentStep < 0) currentStep = 0;
    showTab(currentStep);
  });
});

// --- Bloquer le clic direct sur les onglets ---
tabs.forEach((tab, i) => {
  tab.addEventListener("click", (e) => {
    e.preventDefault();

    // Si on essaie d'aller plus loin que le step actuel
    if (i > currentStep) {
      alert("⚠️ Merci de compléter les étapes précédentes avant de continuer.");
      return;
    }

    // Sinon on affiche l'onglet demandé
    currentStep = i;
    showTab(i);
  });
});
</script>

{% endblock %}




