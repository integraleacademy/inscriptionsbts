{% extends "base.html" %}
{% block body_class %}admin-page{% endblock %}
{% block content %}

<div class="admin-wrapper">

  <!-- 🔝 En-tête -->
  <header class="admin-header">
    <h2>📋 Administration — Pré-inscriptions BTS 2026</h2>
    <div class="admin-actions">
      <a href="{{ url_for('admin_export_csv') }}" class="btn secondary">📄 Export CSV</a>
      <a href="{{ url_for('admin_export_json') }}" class="btn secondary">💾 Export JSON</a>
    </div>
  </header>

  <!-- 🔎 Barre de filtres -->
  <form method="get" action="{{ url_for('admin') }}" class="filter-bar">
    <input type="text" name="q" placeholder="🔍 Rechercher (nom, prénom, mail...)" value="{{ request.args.get('q','') }}">
    
    <select name="bts">
      <option value="">BTS (tous)</option>
      <option value="MOS">MOS</option>
      <option value="MCO">MCO</option>
      <option value="PI">PI</option>
      <option value="CI">CI</option>
      <option value="NDRC">NDRC</option>
      <option value="CG">CG</option>
    </select>

    <select name="mode">
      <option value="">Mode (tous)</option>
      <option value="presentiel">Présentiel</option>
      <option value="distanciel">Distanciel</option>
    </select>

    <select name="statut">
      <option value="">Statut (tous)</option>
      {% for key,label,color in statuts %}
        <option value="{{ key }}">{{ label }}</option>
      {% endfor %}
    </select>

    <select name="label">
      <option value="">Étiquette</option>
      <option value="APS">APS</option>
      <option value="AUT">AUT OK</option>
      <option value="CHEQUE">Chèque OK</option>
    </select>

    <button class="btn primary" type="submit">Filtrer</button>
    <a class="btn" href="{{ url_for('admin') }}">Réinitialiser</a>
  </form>

  <!-- 📊 Tableau -->
  <div class="table-container">
    <table class="admin-table">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Prénom</th>
          <th>BTS</th>
          <th>Mode</th>
          <th>Téléphone</th>
          <th>Email</th>
          <th>Statut</th>
          <th>Étiquettes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr data-id="{{ r.id }}" data-nouveau="{{ r.nouveau_doc }}">
          <td contenteditable="true" data-field="nom">{{ r.nom }}</td>
          <td contenteditable="true" data-field="prenom">{{ r.prenom }}</td>
          <td contenteditable="true" data-field="bts">{{ r.bts }}</td>
          <td contenteditable="true" data-field="mode">{{ r.mode }}</td>
          <td contenteditable="true" data-field="tel">{{ r.tel }}</td>
          <td contenteditable="true" data-field="email">{{ r.email }}</td>
          <td>
            <select data-field="statut" class="status-select" style="background: var(--{{ r.statut or 'preinscription' }});">
              {% for key,label,color in statuts %}
                <option value="{{ key }}" {% if r.statut==key %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </td>
          <td class="etiquettes">
            <label><input type="checkbox" class="chk" data-field="label_aps" {% if r.label_aps %}checked{% endif %}> APS</label>
            <label><input type="checkbox" class="chk" data-field="label_aut_ok" {% if r.label_aut_ok %}checked{% endif %}> AUT OK</label>
            <label><input type="checkbox" class="chk" data-field="label_cheque_ok" {% if r.label_cheque_ok %}checked{% endif %}> Chèque OK</label>
          </td>
         <td>
  <button class="btn small" onclick="openActionsModal('{{ r.id }}', `{{ r.commentaires|default('')|escape }}`)">⋯</button>
  <button class="btn small" onclick="openFilesModal('{{ r.id }}')">📎 Pièces justificatives</button>
</td>

        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ⚙️ MODALE D’ACTIONS -->
<div id="actionsModal" class="modal hidden">
  <div class="modal-content">
    <h3>⚙️ Actions</h3>
 <div class="modal-actions">
  <button id="printLink" class="btn pdf">🖨️ Imprimer la fiche PDF</button>
  <button id="reconfirmBtn" class="btn reconfirm">🔁 Reconfirmation inscription</button>
  <button id="deleteBtn" class="btn danger">🗑️ Supprimer</button>
</div>

    <hr>
    <h4>💬 Commentaires</h4>
    <textarea id="commentBox" rows="4" placeholder="Ajouter ou modifier un commentaire..."></textarea>
    <div class="comment-save">
      <button id="saveCommentBtn" class="btn primary">💾 Enregistrer</button>
      <button class="btn" onclick="closeActionsModal()">Fermer</button>
    </div>
  </div>
</div>

<!-- 📎 MODALE – PIÈCES JUSTIFICATIVES -->
<div id="filesModal" class="modal hidden">
  <div class="modal-content" style="width:700px;max-height:90vh;overflow-y:auto;">
    <h3>📎 Pièces justificatives</h3>

    <div id="filesList" class="files-list">
      <p>Chargement des documents...</p>
    </div>

    <div class="modal-actions">
      <button id="downloadAllBtn" class="btn pdf">⬇️ Télécharger toutes les pièces</button>
      <button class="btn" onclick="closeFilesModal()">Fermer</button>
    </div>
  </div>
</div>

{% endblock %}
