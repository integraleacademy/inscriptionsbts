{% extends "base.html" %}
{% block body_class %}admin-page{% endblock %}
{% block content %}

<div class="admin-wrapper">

  <!-- ğŸ” En-tÃªte -->
<header class="admin-header">
  <h2>ğŸ“‹ Administration â€” PrÃ©-inscriptions BTS 2026</h2>

  <button class="btn primary" id="btnPortal">
  ğŸ”’ Gestion Portail
</button>

  <div class="admin-actions">
    <a href="{{ url_for('parcoursup.dashboard') }}" class="btn secondary" style="display:inline-flex;align-items:center;gap:6px;">
      ğŸ“‹ Gestion Parcoursup
    </a>

    <a href="{{ url_for('admin_export_csv') }}" class="btn secondary">ğŸ“„ Export CSV</a>
    <a href="{{ url_for('admin_export_json') }}" class="btn secondary">ğŸ’¾ Export JSON</a>

    <form action="{{ url_for('admin_clear_db') }}" method="post" style="display:inline"
          onsubmit="return confirm('âš ï¸ ÃŠtes-vous sÃ»r de vouloir tout effacer ? Cette action est irrÃ©versible.')">
      <button class="btn danger">ğŸ—‘ï¸ Vider la base</button>
    </form>
  </div>
</header>


  <!-- ğŸ” Barre de filtres -->
  <form method="get" action="{{ url_for('admin') }}" class="filter-bar">
    <input type="text" 
       id="searchBTS" 
       name="q" 
       placeholder="ğŸ” Rechercher (nom, prÃ©nom, mail...)" 
       value="{{ request.args.get('q','') }}">


    <select name="bts">
      <option value="">BTS (tous)</option>
      <option value="MOS">MOS</option>
      <option value="MCO">MCO</option>
      <option value="PI">PI</option>
      <option value="CI">CI</option>
      <option value="NDRC">NDRC</option>
      <option value="CG">CG</option>
    </select>

    <select name="mode">
      <option value="">Mode (tous)</option>
      <option value="presentiel">PrÃ©sentiel</option>
      <option value="distanciel">Distanciel</option>
    </select>

    <select name="statut">
      <option value="">Statut (tous)</option>
      {% for key,label,color in statuts %}
        <option value="{{ key }}">{{ label }}</option>
      {% endfor %}
    </select>

    <select name="label">
      <option value="">Ã‰tiquette</option>
      <option value="APS">APS</option>
      <option value="AUT">AUT OK</option>
      <option value="CHEQUE">ChÃ¨que OK</option>
    </select>

    <button class="btn primary" type="submit">Filtrer</button>
    <a class="btn secondary" href="{{ url_for('admin') }}">â†» RÃ©initialiser</a>
  </form>

  <!-- ğŸ“Š Tableau -->
  <div class="table-container">
    <table class="admin-table">
      <thead>
        <tr>
          <th>Nom</th>
          <th>PrÃ©nom</th>
          <th>BTS</th>
          <th>Mode</th>
          <th>TÃ©lÃ©phone</th>
          <th>Email</th>
          <th>Statut</th>
          <th>Ã‰tiquettes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr data-id="{{ r.id }}" data-nouveau="{{ r.nouveau_doc }}">
          <td contenteditable="true" data-field="nom">{{ r.nom }}</td>
          <td contenteditable="true" data-field="prenom">{{ r.prenom }}</td>
          <td contenteditable="true" data-field="bts">{{ r.bts }}</td>
          <td contenteditable="true" data-field="mode">{{ r.mode }}</td>
          <td contenteditable="true" data-field="tel">{{ r.tel }}</td>
          <td contenteditable="true" data-field="email">{{ r.email }}</td>
          <td>
            <select data-field="statut" class="status-select" data-statut="{{ r.statut or 'preinscription' }}">
              {% for key,label,color in statuts %}
                <option value="{{ key }}" {% if r.statut==key %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </td>
     <td class="etiquettes">
  <label><input type="checkbox" class="chk" data-field="label_aps" {% if r.label_aps %}checked{% endif %}> APS</label>
  <label><input type="checkbox" class="chk" data-field="label_aut_ok" {% if r.label_aut_ok %}checked{% endif %}> AUT OK</label>
  <label><input type="checkbox" class="chk" data-field="label_cheque_ok" {% if r.label_cheque_ok %}checked{% endif %}> ChÃ¨que OK</label>
  <label><input type="checkbox" class="chk" data-field="label_ypareo" {% if r.label_ypareo %}checked{% endif %}> YPAREO</label>
  <label><input type="checkbox" class="chk" data-field="label_carte_etudiante" {% if r.label_carte_etudiante %}checked{% endif %}> Carte Ã©tudiante</label>
</td>

<td style="text-align:center; white-space:nowrap;">
  <a href="{{ url_for('admin_espace_candidat', cid=r.id) }}" 
     class="btn small" 
     target="_blank"
     style="background:#f4c45a;color:#111;font-weight:600;">
     ğŸ‘ï¸ Espace
  </a>

  <button class="btn small action-btn" 
          data-id="{{ r.id }}" 
          data-commentaire="{{ r.commentaires|default('')|escape }}">
    âš™ï¸ Actions
  </button>

  {% if r.nouveau_doc %}
    <span style="color:#28a745;font-weight:600;margin-left:8px;">ğŸ“¥ Nouveau document dÃ©posÃ©</span>
  {% endif %}
  {% if r.last_relance %}
  <span style="
    background:#28a745;
    color:white;
    padding:2px 6px;
    border-radius:6px;
    font-size:12px;
    margin-left:6px;
    display:inline-block;">
    ğŸ”” RelancÃ©
  </span>
{% endif %}
</td>



        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- âš™ï¸ MODALE Dâ€™ACTIONS -->
<div id="actionsModal" class="modal hidden">
  <div class="modal-content">
    <h3>âš™ï¸ Actions</h3>
    <div class="modal-actions">
      <button id="printLink" class="btn pdf">ğŸ–¨ï¸ Imprimer la fiche PDF</button>
      <button id="reconfirmBtn" class="btn reconfirm">ğŸ” Reconfirmation inscription</button>
      <button id="deleteBtn" class="btn danger">ğŸ—‘ï¸ Supprimer</button>
      <button id="openFilesFromActions" class="btn secondary">ğŸ“ PiÃ¨ces justificatives</button>
    </div>

    <div class="modal-actions" style="margin-top:10px;flex-wrap:wrap;gap:8px;">
      <button id="renvoiMailsBtn" class="btn" style="background:#007bff;color:white;font-weight:600;">
  ğŸ“§ Renvoi mails
</button>
<button id="relancesBtn" class="btn" style="background:#28a745;color:white;font-weight:600;">
  ğŸ“² Relances
</button>
<button id="logsBtn" class="btn" style="background:#6c757d;color:white;">
  ğŸ•“ Logs
</button>
<button id="generationDocsBtn" class="btn" style="background:#f4c45a;color:black;font-weight:600;">
  ğŸ§¾ GÃ©nÃ©ration documents
</button>

    </div>


    <hr>
    <h4>ğŸ’¬ Commentaires</h4>
    <textarea id="commentBox" rows="4" placeholder="Ajouter ou modifier un commentaire..."></textarea>
    <div class="comment-save">
      <button id="saveCommentBtn" class="btn primary">ğŸ’¾ Enregistrer</button>
      <button class="btn" onclick="closeActionsModal()">Fermer</button>
    </div>
  </div>
</div>

<!-- ğŸ“ MODALE â€“ PIÃˆCES JUSTIFICATIVES -->
<div id="filesModal" class="modal hidden">
  <div class="modal-content" style="width:750px;max-height:90vh;overflow-y:auto;">
    <h3>ğŸ“ PiÃ¨ces justificatives</h3>

    <div id="filesList" class="files-list">
      <p>Chargement des documents...</p>
    </div>

    <hr>

    <div id="nonConformesBlock" style="background:#fff8e1;padding:10px 15px;border-radius:8px;margin-top:10px;">
      <h4 style="margin-top:0;">âš ï¸ PiÃ¨ces non conformes</h4>
      <ul id="nonConformesList" style="margin:0;padding-left:20px;font-size:14px;color:#c00;">
        <li>Aucune piÃ¨ce non conforme</li>
      </ul>
    </div>

    <div style="margin-top:15px;">
      <label for="commentaireNonConforme" style="font-weight:600;">ğŸ—’ï¸ Commentaire (optionnel)</label><br>
      <textarea id="commentaireNonConforme" rows="3" style="width:100%;border-radius:6px;padding:8px;border:1px solid #ccc;"></textarea>
    </div>

    <div class="modal-actions" style="margin-top:15px;">
      <button id="notifyNonConformesBtn" class="btn danger">ğŸ“© Enregistrer et notifier le candidat</button>
      <button id="downloadAllBtn" class="btn pdf">â¬‡ï¸ TÃ©lÃ©charger toutes les piÃ¨ces</button>
      <button id="markDocsCheckedBtn" class="btn success">âœ… Nouveau document contrÃ´lÃ©</button>
      <button id="mergeDocsBtn" class="btn secondary">ğŸ’¾ Enregistrer les nouveaux documents</button>
      <button class="btn" onclick="closeFilesModal()">Fermer</button>
    </div>
  </div>
</div>

<!-- ğŸ“§ MODALE â€” RENVOI MAILS (mail + SMS) -->
<div id="renvoiMailsModal" class="modal hidden">
  <div class="modal-content" style="width:600px;max-width:95vw;">
    <h3>ğŸ“§ Renvoi mails</h3>
    <p>Choisissez le <strong>mail + SMS</strong> Ã  renvoyer au candidat :</p>
    <div class="modal-actions" style="flex-direction:column;align-items:stretch;gap:8px;">
      <button class="btn secondary renvoi-option" data-action="candidature_validee">
        âœ… Renvoi mail + SMS Candidature validÃ©e
      </button>
      <button class="btn secondary renvoi-option" data-action="inscription_confirmee">
        ğŸ“© Renvoi mail + SMS Inscription confirmÃ©e
      </button>
      <button class="btn secondary renvoi-option" data-action="reconfirmation">
        ğŸ” Renvoi mail + SMS Reconfirmer inscription
      </button>
      <button class="btn secondary renvoi-option" data-action="reconfirmee">
        âœ… Renvoi mail + SMS Inscription re-confirmÃ©e
      </button>
      <button class="btn secondary renvoi-option" data-action="docs_non_conformes">
        ğŸš« Renvoi mail + SMS Docs non conformes
      </button>
    </div>
    <div class="comment-save">
      <button class="btn" onclick="closeRenvoiMailsModal()">Fermer</button>
    </div>
  </div>
</div>


<div id="relancesModal" class="modal hidden">
  <div class="modal-content" style="width:600px;max-width:95vw;">
    <h3>ğŸ“² Relances</h3>
    <p>Choisissez la <strong>relance (mail + SMS)</strong> Ã  envoyer :</p>
    <div class="modal-actions" style="flex-direction:column;align-items:stretch;gap:8px;">
      <button class="btn success relance-option" data-action="candidature_validee">
        ğŸ”” Relance candidature validÃ©e (le candidat nâ€™a pas confirmÃ© son inscription)
      </button>
      <button class="btn success relance-option" data-action="reconfirmation">
        ğŸ” Relance reconfirmation (reconfirmation demandÃ©e mais non validÃ©e)
      </button>
      <button class="btn success relance-option" data-action="docs_non_conformes">
        ğŸš« Relance docs non conformes (documents non renvoyÃ©s)
      </button>
    </div>
    <div class="comment-save">
      <button class="btn" onclick="closeRelancesModal()">Fermer</button>
    </div>
  </div>
</div>


<!-- ğŸ•“ MODALE â€” LOGS -->
<div id="logsModal" class="modal hidden">
  <div class="modal-content" style="width:700px;max-height:90vh;overflow-y:auto;">
    <h3>ğŸ•“ Historique des actions</h3>
    <ul id="logsList" style="list-style:none;padding:0;margin:0;font-size:14px;">
      <li>Chargement des logs...</li>
    </ul>
    <div class="comment-save">
      <button class="btn" onclick="closeLogsModal()">Fermer</button>
    </div>
  </div>
</div>

<!-- ğŸ§¾ MODALE â€” GÃ‰NÃ‰RATION DOCUMENTS -->
<div id="generationDocsModal" class="modal hidden">
  <div class="modal-content" style="width:600px;">
    <h3>ğŸ§¾ GÃ©nÃ©ration de documents</h3>
    <p>Choisissez le document Ã  gÃ©nÃ©rer pour ce candidat :</p>

<div class="modal-actions">
  <button id="generateCertificatDistBtn" class="btn pdf">ğŸ“œ GÃ©nÃ©rer certificat Distanciel</button>
  <button id="generateCertificatPresBtn" class="btn pdf">ğŸ“œ GÃ©nÃ©rer certificat PrÃ©sentiel</button>
  <button id="sendCertificatDistBtn" class="btn secondary">âœ‰ï¸ Envoyer certificat Distanciel</button>
  <button id="sendCertificatPresBtn" class="btn secondary">âœ‰ï¸ Envoyer certificat PrÃ©sentiel</button>
</div>


    <div class="comment-save">
      <button class="btn" onclick="closeGenerationDocsModal()">Fermer</button>
    </div>
  </div>
</div>

<!-- ğŸ” MODALE â€” GESTION PORTAIL -->
<div id="portalModal" class="modal hidden">
  <div class="modal-content" style="width:480px;">
    <h3>ğŸ” Gestion du portail dâ€™inscriptions</h3>
    <p>Choisissez lâ€™Ã©tat actuel du portail :</p>

    <div style="margin:15px 0;">
      <label><input type="radio" name="portalStatus" value="open"> ğŸŸ¢ Ouvrir les inscriptions</label><br>
      <label><input type="radio" name="portalStatus" value="closed"> ğŸ”´ Fermer les inscriptions</label>
    </div>

    <div id="portalMessageBlock" style="display:none;margin-top:10px;">
  <label for="portalMessage"><strong>Message affichÃ© sur la page dâ€™accueil :</strong></label><br>
  <select id="portalMessage" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
    <option value="Les prÃ©-inscriptions sont actuellement fermÃ©es. Ouverture prochainement.">ğŸ•’ PrÃ©-inscriptions actuellement fermÃ©es</option>
    <option value="Notre site internet est actuellement en maintenance technique. Merci de revenir plus tard.">ğŸ› ï¸ Maintenance technique en cours</option>
  </select>

  <!-- ğŸ—’ï¸ Nouveau champ commentaire -->
  <div style="margin-top:10px;">
    <label for="portalComment"><strong>ğŸ—’ï¸ Commentaire (optionnel) :</strong></label><br>
    <textarea id="portalComment" rows="2" style="width:100%;border-radius:6px;padding:8px;border:1px solid #ccc;" placeholder="Exemple : maintenance du 31/10 au 02/11, mise Ã  jour des formulaires..."></textarea>
  </div>
</div>

    <div class="modal-actions" style="margin-top:20px;">
      <button id="savePortalBtn" class="btn primary">ğŸ’¾ Enregistrer</button>
      <button class="btn" onclick="closePortalModal()">Fermer</button>
    </div>
  </div>
</div>

{% endblock %}
