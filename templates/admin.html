{% extends "base.html" %}
{% block body_class %}admin-page{% endblock %}
{% block content %}

<div class="admin-wrapper">

  <!-- ğŸ” En-tÃªte -->
  <header class="admin-header">
    <h2>ğŸ“‹ Administration â€” PrÃ©-inscriptions BTS 2026</h2>
    <div class="admin-actions">
      <a href="{{ url_for('admin_export_csv') }}" class="btn secondary">ğŸ“„ Export CSV</a>
      <a href="{{ url_for('admin_export_json') }}" class="btn secondary">ğŸ’¾ Export JSON</a>
    </div>
  </header>

  <!-- ğŸ” Barre de filtres -->
  <form method="get" action="{{ url_for('admin') }}" class="filter-bar">
    <input type="text" name="q" placeholder="ğŸ” Rechercher (nom, prÃ©nom, mail...)" value="{{ request.args.get('q','') }}">
    
    <select name="bts">
      <option value="">BTS (tous)</option>
      <option value="MOS">MOS</option>
      <option value="MCO">MCO</option>
      <option value="PI">PI</option>
      <option value="CI">CI</option>
      <option value="NDRC">NDRC</option>
      <option value="CG">CG</option>
    </select>

    <select name="mode">
      <option value="">Mode (tous)</option>
      <option value="presentiel">PrÃ©sentiel</option>
      <option value="distanciel">Distanciel</option>
    </select>

    <select name="statut">
      <option value="">Statut (tous)</option>
      {% for key,label,color in statuts %}
        <option value="{{ key }}">{{ label }}</option>
      {% endfor %}
    </select>

    <select name="label">
      <option value="">Ã‰tiquette</option>
      <option value="APS">APS</option>
      <option value="AUT">AUT OK</option>
      <option value="CHEQUE">ChÃ¨que OK</option>
    </select>

    <button class="btn primary" type="submit">Filtrer</button>
    <a class="btn" href="{{ url_for('admin') }}">RÃ©initialiser</a>
  </form>

  <!-- ğŸ“Š Tableau -->
  <div class="table-container">
    <table class="admin-table">
      <thead>
        <tr>
          <th>Nom</th>
          <th>PrÃ©nom</th>
          <th>BTS</th>
          <th>Mode</th>
          <th>TÃ©lÃ©phone</th>
          <th>Email</th>
          <th>Statut</th>
          <th>Ã‰tiquettes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr data-id="{{ r.id }}">
          <td contenteditable="true" data-field="nom">{{ r.nom }}</td>
          <td contenteditable="true" data-field="prenom">{{ r.prenom }}</td>
          <td contenteditable="true" data-field="bts">{{ r.bts }}</td>
          <td contenteditable="true" data-field="mode">{{ r.mode }}</td>
          <td contenteditable="true" data-field="tel">{{ r.tel }}</td>
          <td contenteditable="true" data-field="email">{{ r.email }}</td>
          <td>
            <select data-field="statut" class="status-select" style="background: var(--{{ r.statut or 'preinscription' }});">
              {% for key,label,color in statuts %}
                <option value="{{ key }}" {% if r.statut==key %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </td>
          <td class="etiquettes">
            <label><input type="checkbox" class="chk" data-field="label_aps" {% if r.label_aps %}checked{% endif %}> APS</label>
            <label><input type="checkbox" class="chk" data-field="label_aut_ok" {% if r.label_aut_ok %}checked{% endif %}> AUT OK</label>
            <label><input type="checkbox" class="chk" data-field="label_cheque_ok" {% if r.label_cheque_ok %}checked{% endif %}> ChÃ¨que OK</label>
          </td>
         <td>
  <button class="btn small" onclick="openActionsModal('{{ r.id }}', `{{ r.commentaires|default('')|escape }}`)">â‹¯</button>
  <button class="btn small" onclick="openFilesModal('{{ r.id }}')">ğŸ“ PiÃ¨ces justificatives</button>
</td>

        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- âš™ï¸ MODALE Dâ€™ACTIONS -->
<div id="actionsModal" class="modal hidden">
  <div class="modal-content">
    <h3>âš™ï¸ Actions</h3>
 <div class="modal-actions">
  <button id="printLink" class="btn pdf">ğŸ–¨ï¸ Imprimer la fiche PDF</button>
  <button id="reconfirmBtn" class="btn reconfirm">ğŸ” Reconfirmation inscription</button>
  <button id="deleteBtn" class="btn danger">ğŸ—‘ï¸ Supprimer</button>
</div>

    <hr>
    <h4>ğŸ’¬ Commentaires</h4>
    <textarea id="commentBox" rows="4" placeholder="Ajouter ou modifier un commentaire..."></textarea>
    <div class="comment-save">
      <button id="saveCommentBtn" class="btn primary">ğŸ’¾ Enregistrer</button>
      <button class="btn" onclick="closeActionsModal()">Fermer</button>
    </div>
  </div>
</div>

<!-- ğŸ“ MODALE â€“ PIÃˆCES JUSTIFICATIVES -->
<div id="filesModal" class="modal hidden">
  <div class="modal-content" style="width:700px;max-height:90vh;overflow-y:auto;">
    <h3>ğŸ“ PiÃ¨ces justificatives</h3>

    <div id="filesList" class="files-list">
      <p>Chargement des documents...</p>
    </div>

    <div class="modal-actions">
      <button id="downloadAllBtn" class="btn pdf">â¬‡ï¸ TÃ©lÃ©charger toutes les piÃ¨ces</button>
      <button class="btn" onclick="closeFilesModal()">Fermer</button>
    </div>
  </div>
</div>


<!-- ğŸ’¾ Script -->
<script>
let currentId = null;

function openActionsModal(id, comment="") {
  currentId = id;
  document.getElementById("actionsModal").classList.remove("hidden");
  document.getElementById("printLink").href = "/admin/print/" + id;
  document.getElementById("commentBox").value = comment || "";
}

function closeActionsModal() {
  document.getElementById("actionsModal").classList.add("hidden");
}

// Enregistrement commentaire
document.getElementById("saveCommentBtn").addEventListener("click", ()=>{
  const value = document.getElementById("commentBox").value;
  fetch("/admin/update-field", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({id: currentId, field: "commentaires", value})
  }).then(()=>showToast("ğŸ’¾ Commentaire enregistrÃ©","#f4c45a"));
});

// Reconfirmation
document.getElementById("reconfirmBtn").addEventListener("click", async ()=>{
  if (!currentId) return;
  const btn = document.getElementById("reconfirmBtn");
  btn.disabled = true;
  btn.textContent = "â³ Envoi...";
  await fetch("/admin/reconfirm/" + currentId, {method:"POST"});
  btn.textContent = "âœ… Reconfirmation envoyÃ©e";
  btn.style.background = "#28a745";
});

// Suppression
document.getElementById("deleteBtn").addEventListener("click", async ()=>{
  if (!currentId) return;
  if (!confirm("âš ï¸ Supprimer dÃ©finitivement cette fiche ?")) return;
  await fetch("/admin/delete/" + currentId, {method:"POST"});
  document.querySelector(`tr[data-id='${currentId}']`)?.remove();
  closeActionsModal();
  showToast("ğŸ—‘ï¸ Fiche supprimÃ©e","#d9534f");
});

// Toast notification
function showToast(msg,color="#333"){
  const t=document.createElement("div");
  t.textContent=msg;
  Object.assign(t.style,{
    position:"fixed",bottom:"20px",right:"20px",background:color,color:"#fff",
    padding:"10px 16px",borderRadius:"8px",fontWeight:"600",boxShadow:"0 3px 8px rgba(0,0,0,.3)",
    zIndex:"9999",opacity:"0",transition:"opacity .3s"
  });
  document.body.appendChild(t);
  setTimeout(()=>t.style.opacity="1",50);
  setTimeout(()=>{t.style.opacity="0";setTimeout(()=>t.remove(),300)},2500);
}

  // =======================================================
// ğŸ“ GESTION DES PIÃˆCES JUSTIFICATIVES
// =======================================================
function openFilesModal(id) {
  currentId = id;
  const modal = document.getElementById("filesModal");
  const list = document.getElementById("filesList");
  modal.classList.remove("hidden");
  list.innerHTML = "<p>â³ Chargement des piÃ¨ces...</p>";

  fetch(`/admin/files/${id}`)
    .then(res => res.json())
    .then(files => {
      if (!files.length) {
        list.innerHTML = "<p>Aucune piÃ¨ce justificative trouvÃ©e.</p>";
        return;
      }

      list.innerHTML = "";
      files.forEach(f => {
        const div = document.createElement("div");
        div.className = "file-item";
        div.innerHTML = `
          <div class="file-header">
            <strong>${f.label}</strong><br>
            <a href="/data/uploads/${f.filename}" target="_blank" rel="noopener noreferrer">${f.filename}</a>

          </div>
          <div class="file-actions">
            <button class="btn small ok" data-filename="${f.filename}" ${f.status==="conforme"?"disabled":""}>âœ… Conforme</button>
            <button class="btn small danger" data-filename="${f.filename}" ${f.status==="non_conforme"?"disabled":""}>âŒ Non conforme</button>

          </div>
        `;
        list.appendChild(div);
      });
    })
    .catch(err => {
      list.innerHTML = "<p style='color:red'>Erreur de chargement</p>";
      console.error(err);
    });
}

function closeFilesModal() {
  document.getElementById("filesModal").classList.add("hidden");
}

// ğŸ“© Marquer une piÃ¨ce comme conforme / non conforme
function markDoc(filename, decision) {
  if (!currentId) return;
  fetch("/admin/files/mark", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({id: currentId, filename, decision})
  })
  .then(res => res.json())
  .then(data => {
    if (data.ok) {
      showToast(decision==="conforme" ? "âœ… Document conforme" : "âŒ Document non conforme",
        decision==="conforme" ? "#28a745" : "#d9534f");
      openFilesModal(currentId); // recharge la liste
    }
  });
}

// ğŸ“¦ TÃ©lÃ©charger toutes les piÃ¨ces
document.getElementById("downloadAllBtn").addEventListener("click", ()=>{
  if (!currentId) return;
  window.open(`/admin/files/download/${currentId}`, "_blank");
});

</script>

{% endblock %}
